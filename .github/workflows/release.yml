name: Release Pipeline (Full)

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: '.NET SDK version'
        required: false
        type: string
        default: '9.0.x'
      working-directory:
        description: 'Working directory for dotnet commands'
        required: false
        type: string
        default: '.'
      image-name:
        description: 'Full image name (e.g., ghcr.io/org/service)'
        required: true
        type: string
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      build-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
    secrets:
      github-token:
        description: 'GitHub token with contents and packages write permissions'
        required: true
    outputs:
      version:
        description: 'Released version (empty if no release)'
        value: ${{ jobs.semantic.outputs.version }}
      image-tag:
        description: 'Full image tag that was pushed'
        value: ${{ jobs.deploy.outputs.image-tag }}

jobs:
  ci:
    uses: ./.github/workflows/ci.yml
    with:
      dotnet-version: ${{ inputs.dotnet-version }}
      working-directory: ${{ inputs.working-directory }}

  semantic:
    needs: ci
    uses: ./.github/workflows/semantic.yml
    secrets:
      github-token: ${{ secrets.github-token }}

  deploy:
    needs: semantic
    if: needs.semantic.outputs.version != ''
    uses: ./.github/workflows/cd.yml
    with:
      version: ${{ needs.semantic.outputs.version }}
      image-name: ${{ inputs.image-name }}
      dockerfile-path: ${{ inputs.dockerfile-path }}
      build-context: ${{ inputs.build-context }}
    secrets:
      registry-token: ${{ secrets.github-token }}
